@model IEnumerable<ExchangeRate>
@using PRN222_Assignment4_Option1.BusinessLogic.Dtos
@{
    ViewData["Title"] = "Danh sách tỷ giá";
    var dateFilter = ViewBag.DateFilter as DateTime?;
    var currentPage = (int)ViewBag.Page;
    var hasNext = (bool)ViewBag.HasNextPage;
    var hasPrev = (bool)ViewBag.HasPrevPage;
    var isWorkerRunning = ViewBag.IsWorkerRunning is bool b && b;
    var workerStatusMessage = ViewBag.WorkerStatusMessage as string;

    var apiHasFilter = ViewBag.ApiHasFilter is bool bb && bb;
    var apiDate = ViewBag.ApiDate as DateTime?;
    string apiBaseInput = ViewBag.ApiBaseInput as string ?? "";
    string apiSymbolsInput = ViewBag.ApiSymbolsInput as string ?? "";
    var apiResponse = ViewBag.ApiResponse as FrankfurterHistoricalResponse;
}

@section Scripts {
    <script>
        setTimeout(function () { location.reload(); }, 10000);
    </script>
}

<h1 class="mb-3">@ViewData["Title"]</h1>
<p class="text-muted mb-3">Chọn ngày bên dưới để <strong>lọc theo ngày</strong>, hoặc để trống để xem tất cả. <a asp-action="Latest" class="text-decoration-none">→ Xem tỷ giá mới nhất</a></p>

@if (!string.IsNullOrEmpty(workerStatusMessage))
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        @workerStatusMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="card mb-3">
    <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div>
            <span class="fw-semibold">Trạng thái Worker:</span>
            @if (isWorkerRunning)
            {
                <span class="badge bg-success ms-1">Đang chạy</span>
            }
            else
            {
                <span class="badge bg-danger ms-1">Đã dừng</span>
            }
        </div>
        <div class="d-flex gap-2">
            @if (isWorkerRunning)
            {
                <form asp-action="StopWorker" method="post">
                    <button type="submit" class="btn btn-outline-danger btn-sm">Dừng Worker (CancellationToken)</button>
                    @Html.AntiForgeryToken()
                </form>
            }
            else
            {
                <form asp-action="StartWorker" method="post">
                    <button type="submit" class="btn btn-outline-success btn-sm">Chạy lại Worker</button>
                    @Html.AntiForgeryToken()
                </form>
            }
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body py-3">
        <h6 class="card-subtitle text-muted mb-2">Lọc theo ngày</h6>
        <form method="get" asp-action="Index" class="row g-3 align-items-end">
            <div class="col-auto">
                <label class="form-label small mb-0">Ngày</label>
                <input type="date" name="date" class="form-control" value="@(dateFilter?.ToString("yyyy-MM-dd"))" />
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Áp dụng</button>
                @if (dateFilter.HasValue)
                {
                    <a asp-action="Index" class="btn btn-outline-secondary ms-1">Bỏ lọc</a>
                }
            </div>
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body py-3">
        <h6 class="card-subtitle text-muted mb-2">Lọc trực tiếp từ API Frankfurter (không dùng DB)</h6>
        <form method="get" asp-action="Index" class="row g-3 align-items-end">
            <input type="hidden" name="page" value="@currentPage" />
            <div class="col-md-3">
                <label class="form-label small mb-0">Ngày</label>
                <input type="date" name="apiDate" class="form-control"
                       value="@((apiDate ?? DateTime.Today).ToString("yyyy-MM-dd"))" />
            </div>
            <div class="col-md-3">
                <label class="form-label small mb-0">Base (tùy chọn)</label>
                <input type="text" name="apiBase" class="form-control"
                       value="@apiBaseInput" placeholder="VD: USD (mặc định: EUR)" />
            </div>
            <div class="col-md-3">
                <label class="form-label small mb-0">Symbols (tùy chọn)</label>
                <input type="text" name="apiSymbols" class="form-control"
                       value="@apiSymbolsInput" placeholder="VD: USD,GBP (mặc định: tất cả)" />
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-outline-primary">Lọc từ API</button>
            </div>
        </form>
        <p class="text-muted small mb-0 mt-2">
            Nếu không nhập gì ở ba ô trên, trang sẽ chỉ hiển thị dữ liệu từ database.
        </p>
    </div>
</div>

@if (!apiHasFilter)
{
    if (!Model.Any())
    {
        <div class="alert alert-info">
            Chưa có dữ liệu tỷ giá cho @(dateFilter.HasValue ? "ngày đã chọn" : "hệ thống"). Worker đang chạy cùng Web — vài giây nữa sẽ có bản ghi mới, hoặc bấm F5 để tải lại.
            <a asp-action="Latest" class="alert-link">Xem tỷ giá mới nhất</a>
        </div>
    }
    else
    {
        if (dateFilter.HasValue)
        {
            <p class="text-muted small mb-2">Đang hiển thị tỷ giá ngày <strong>@dateFilter.Value.ToString("dd/MM/yyyy")</strong></p>
        }
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Base</th>
                        <th>Target</th>
                        <th>Tỷ giá</th>
                        <th>Thời gian</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.BaseCurrency</td>
                            <td>@item.TargetCurrency</td>
                            <td>@item.Rate.ToString("N2")</td>
                            <td>@item.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <nav class="mt-3">
            @if (hasPrev)
            {
                <a asp-action="Index" asp-route-page="@(currentPage - 1)" asp-route-date="@(dateFilter?.ToString("yyyy-MM-dd"))" class="btn btn-outline-primary">Trang trước</a>
            }
            <span class="mx-2">Trang @currentPage</span>
            @if (hasNext)
            {
                <a asp-action="Index" asp-route-page="@(currentPage + 1)" asp-route-date="@(dateFilter?.ToString("yyyy-MM-dd"))" class="btn btn-outline-primary">Trang sau</a>
            }
        </nav>
    }
}

@if (apiHasFilter)
{
    <hr class="my-4" />

    <h2 class="h5 mb-3">Kết quả từ API Frankfurter</h2>

    @if (apiResponse is null)
    {
        <p class="text-muted">
            Không có dữ liệu từ API cho cấu hình đã nhập.
        </p>
    }
    else
    {
        <p class="text-muted">
            Base: <strong>@apiResponse.Base</strong> &nbsp;|&nbsp;
            Ngày dữ liệu: <strong>@apiResponse.Date.ToString("dd/MM/yyyy")</strong>
        </p>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Base</th>
                        <th>Target</th>
                        <th>Tỷ giá</th>
                        <th>Thời gian</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var kv in apiResponse.Rates.OrderBy(r => r.Key))
                    {
                        <tr>
                            <td>@apiResponse.Base</td>
                            <td>@kv.Key</td>
                            <td>@kv.Value.ToString("N4")</td>
                            <td>@apiResponse.Date.ToString("yyyy-MM-dd")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
}


