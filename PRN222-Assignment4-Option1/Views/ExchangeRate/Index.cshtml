@model IEnumerable<ExchangeRate>
@using PRN222_Assignment4_Option1.BusinessLogic.Dtos
@using PRN222_Assignment4_Option1.DataAccess.Entities
@{
    ViewData["Title"] = "Thống kê & Lọc Tỷ giá";
    var startDate = ViewBag.StartDate as DateTime?;
    var endDate = ViewBag.EndDate as DateTime?;
    var baseCurrency = ViewBag.BaseCurrency as string;
    var symbols = ViewBag.Symbols as string;
    var currentPage = (int)ViewBag.Page;
    var hasNext = (bool)ViewBag.HasNextPage;
    var hasPrev = (bool)ViewBag.HasPrevPage;
    var isWorkerRunning = ViewBag.IsWorkerRunning is bool b && b;
    var workerStatusMessage = ViewBag.WorkerStatusMessage as string;
}

@section Scripts {
    @if (isWorkerRunning)
    {
        <script>
            setTimeout(function () { location.reload(); }, 15000);
        </script>
    }
}

<div class="container-fluid px-4 py-3">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h2 text-primary fw-bold mb-1">@ViewData["Title"]</h1>
            <p class="text-muted small mb-0">Lọc và tra cứu lịch sử tỷ giá từ cơ sở dữ liệu hệ thống.</p>
        </div>
        <div class="d-flex gap-2">
            <a asp-action="Latest" class="btn btn-primary shadow-sm">
                <i class="bi bi-clock-history me-1"></i> Tỷ giá mới nhất
            </a>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(workerStatusMessage))
    {
        <div class="alert alert-info alert-dismissible fade show shadow-sm border-0 mb-4" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i> @workerStatusMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row g-4 mb-4">
        <!-- Worker Status Card -->
        <div class="col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted mb-3 text-uppercase small ls-wide">Trạng thái Hệ thống</h6>
                    <div class="d-flex align-items-center mb-3">
                        @if (isWorkerRunning)
                        {
                            <span class="pulse-green me-2"></span>
                            <span class="fw-bold text-success">Đang thu thập</span>
                        }
                        else
                        {
                            <span class="pulse-red me-2"></span>
                            <span class="fw-bold text-danger">Đã dừng</span>
                        }
                    </div>
                    <div class="d-grid gap-2">
                        @if (isWorkerRunning)
                        {
                            <form asp-action="StopWorker" method="post">
                                <button type="submit" class="btn btn-outline-danger btn-sm w-100 shadow-none">Dừng Worker</button>
                                @Html.AntiForgeryToken()
                            </form>
                        }
                        else
                        {
                            <form asp-action="StartWorker" method="post">
                                <button type="submit" class="btn btn-outline-success btn-sm w-100 shadow-none">Khởi động lại</button>
                                @Html.AntiForgeryToken()
                            </form>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Filter Card -->
        <div class="col-lg-9">
            <div class="card border-0 shadow-sm overflow-hidden filter-gradient">
                <div class="card-body p-4 position-relative">
                    <h6 class="text-white mb-3 text-uppercase small ls-wide opacity-75">Bộ lọc Nâng cao (Database)</h6>
                    <form method="get" asp-action="Index" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label text-white small opacity-75">Từ ngày</label>
                            <input type="date" name="startDate" class="form-control form-control-sm border-0 bg-white-opacity" value="@(startDate?.ToString("yyyy-MM-dd"))" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-white small opacity-75">Đến ngày</label>
                            <input type="date" name="endDate" class="form-control form-control-sm border-0 bg-white-opacity" value="@(endDate?.ToString("yyyy-MM-dd"))" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label text-white small opacity-75">Base</label>
                            <input type="text" name="baseCurrency" class="form-control form-control-sm border-0 bg-white-opacity text-uppercase" value="@baseCurrency" placeholder="VD: USD" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label text-white small opacity-75">Symbols</label>
                            <input type="text" name="symbols" class="form-control form-control-sm border-0 bg-white-opacity text-uppercase" value="@symbols" placeholder="VD: EUR,VND" title="Phân tách bởi dấu phẩy" />
                        </div>
                        <div class="col-md-2 d-flex align-items-end gap-1">
                            <button type="submit" class="btn btn-light btn-sm w-100 fw-bold shadow-sm">Áp dụng</button>
                            <a asp-action="Index" class="btn btn-white-opacity btn-sm px-3" title="Xóa bộ lọc">
                                <i class="bi bi-x-lg"></i>
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="text-center py-5 border rounded bg-white shadow-sm">
            <div class="mb-3">
                <i class="bi bi-search display-1 text-light"></i>
            </div>
            <h4 class="text-muted">Không tìm thấy tỷ giá nào</h4>
            <p class="text-muted small">Hãy thử điều chỉnh bộ lọc hoặc khởi động lại Worker để thu thập thêm dữ liệu.</p>
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 py-3 text-uppercase small fw-bold text-muted border-0">Base</th>
                                <th class="py-3 text-uppercase small fw-bold text-muted border-0 text-center" style="width: 50px;"><i class="bi bi-arrow-right"></i></th>
                                <th class="py-3 text-uppercase small fw-bold text-muted border-0">Target</th>
                                <th class="py-3 text-uppercase small fw-bold text-muted border-0">Tỷ giá</th>
                                <th class="py-3 text-uppercase small fw-bold text-muted border-0">Thời gian (API)</th>
                                <th class="py-3 text-uppercase small fw-bold text-muted border-0 pe-4">Ngày lưu</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td class="ps-4">
                                        <div class="d-flex align-items-center">
                                            <div class="currency-flag bg-primary text-white me-2">@item.BaseCurrency.Substring(0, 1)</div>
                                            <span class="fw-bold fs-6">@item.BaseCurrency</span>
                                        </div>
                                    </td>
                                    <td class="text-center text-muted"><i class="bi bi-arrow-right small"></i></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="currency-flag bg-info text-white me-2">@item.TargetCurrency.Substring(0, 1)</div>
                                            <span class="fw-semibold">@item.TargetCurrency</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-soft-success text-success fs-6 fw-bold px-2 py-1">@item.Rate.ToString("N4")</span>
                                    </td>
                                    <td>
                                        <span class="text-muted small">@item.Timestamp.ToString("yyyy-MM-dd")</span>
                                    </td>
                                    <td class="pe-4">
                                        <div class="text-muted small">@item.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white py-3 border-0 d-flex align-items-center justify-content-between">
                <p class="text-muted small mb-0">Trang <strong>@currentPage</strong></p>
                <nav>
                    <ul class="pagination pagination-sm mb-0 gap-2">
                        @if (hasPrev)
                        {
                            <li class="page-item">
                                <a class="page-link rounded-pill px-3 shadow-none" asp-action="Index" 
                                   asp-route-page="@(currentPage - 1)" 
                                   asp-route-startDate="@(startDate?.ToString("yyyy-MM-dd"))"
                                   asp-route-endDate="@(endDate?.ToString("yyyy-MM-dd"))"
                                   asp-route-baseCurrency="@baseCurrency"
                                   asp-route-symbols="@symbols">
                                   <i class="bi bi-chevron-left"></i> Trang trước
                                </a>
                            </li>
                        }
                        @if (hasNext)
                        {
                            <li class="page-item">
                                <a class="page-link rounded-pill px-3 shadow-none" asp-action="Index" 
                                   asp-route-page="@(currentPage + 1)" 
                                   asp-route-startDate="@(startDate?.ToString("yyyy-MM-dd"))"
                                   asp-route-endDate="@(endDate?.ToString("yyyy-MM-dd"))"
                                   asp-route-baseCurrency="@baseCurrency"
                                   asp-route-symbols="@symbols">
                                   Trang sau <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        </div>
    }
</div>

<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        --soft-success: #e8f5e9;
    }

    .ls-wide { letter-spacing: 0.1em; }
    
    .filter-gradient {
        background: var(--primary-gradient);
    }

    .bg-white-opacity {
        background: rgba(255, 255, 255, 0.15) !important;
        color: white !important;
        backdrop-filter: blur(5px);
    }
    
    .bg-white-opacity::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }

    .btn-white-opacity {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: none;
    }

    .btn-white-opacity:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    .currency-flag {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .bg-soft-success {
        background-color: var(--soft-success);
    }

    .pulse-green {
        width: 10px;
        height: 10px;
        background: #28a745;
        border-radius: 50%;
        display: inline-block;
        box-shadow: 0 0 0 rgba(40, 167, 69, 0.4);
        animation: pulse-green 2s infinite;
    }

    .pulse-red {
        width: 10px;
        height: 10px;
        background: #dc3545;
        border-radius: 50%;
        display: inline-block;
        box-shadow: 0 0 0 rgba(220, 53, 69, 0.4);
        animation: pulse-red 2s infinite;
    }

    @@keyframes pulse-green {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }

    @@keyframes pulse-red {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
</style>


