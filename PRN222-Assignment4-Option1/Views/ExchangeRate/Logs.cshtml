@using PRN222_Assignment4_Option1.DataAccess.Entities
@model IEnumerable<WorkerLog>
@{
    ViewData["Title"] = "Nhật ký hệ thống (Worker)";
    var intervalSeconds = (int)(ViewBag.IntervalSeconds ?? 5);
    var isWorkerRunning = ViewBag.IsWorkerRunning is bool b && b;
}

@section Scripts {
    @if (isWorkerRunning)
    {
        <script>
            const intervalMs = @intervalSeconds * 1000;
            let remaining = @intervalSeconds;

            const countdownEl = document.getElementById('countdown');
            const barEl = document.getElementById('progress-bar');

            // Update bar width and text every 100ms
            const interval = setInterval(() => {
                remaining -= 0.1;
                if (remaining <= 0) {
                    clearInterval(interval);
                    location.reload();
                    return;
                }
                const pct = (remaining / @intervalSeconds) * 100;
                if (barEl) barEl.style.width = pct + '%';
                if (countdownEl) countdownEl.textContent = Math.ceil(remaining) + 's';
            }, 100);
        </script>
    }
}

<div class="container-fluid px-4 py-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
        <div>
            <h1 class="h2 text-primary fw-bold mb-1">@ViewData["Title"]</h1>
            <p class="text-muted small mb-0">Theo dõi các hoạt động và lỗi phát sinh từ Exchange Rate Worker.</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            @if (isWorkerRunning)
            {
                <span class="badge bg-success-subtle text-success border border-success-subtle px-3 py-2" style="font-size:0.8rem;">
                    <span class="me-1" style="width:8px;height:8px;background:#28a745;border-radius:50%;display:inline-block;animation:pulse-green 1.5s infinite;"></span>
                    Live · làm mới sau <span id="countdown">@intervalSeconds s</span>
                </span>
            }
            else
            {
                <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle px-3 py-2" style="font-size:0.8rem;">
                    Worker đã dừng
                </span>
            }
            <a asp-action="Index" class="btn btn-outline-primary shadow-sm btn-sm">
                <i class="bi bi-arrow-left me-1"></i> Danh sách
            </a>
            <button onclick="location.reload()" class="btn btn-primary shadow-sm btn-sm">
                <i class="bi bi-arrow-clockwise me-1"></i> Làm mới ngay
            </button>
        </div>
    </div>

    @if (isWorkerRunning)
    {
        <div class="progress mb-3" style="height: 3px; border-radius: 0;">
            <div id="progress-bar" class="progress-bar bg-primary" style="width: 100%; transition: width 0.1s linear;"></div>
        </div>
    }
    else
    {
        <div class="mb-3"></div>
    }

    <div class="card border-0 shadow-sm overflow-hidden">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 py-3 text-uppercase small fw-bold text-muted border-0" style="width: 200px;">Thời gian</th>
                            <th class="py-3 text-uppercase small fw-bold text-muted border-0" style="width: 120px;">Mức độ</th>
                            <th class="py-3 text-uppercase small fw-bold text-muted border-0">Thông điệp</th>
                            <th class="py-3 text-uppercase small fw-bold text-muted border-0 text-end pe-4">Chi tiết</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in Model)
                        {
                            var levelClass = log.LogLevel.ToLower() switch
                            {
                                "information" => "bg-soft-info text-info",
                                "warning" => "bg-soft-warning text-warning",
                                "error" => "bg-soft-danger text-danger",
                                _ => "bg-soft-secondary text-secondary"
                            };
                            <tr>
                                <td class="ps-4">
                                    <span class="text-muted small">@log.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                </td>
                                <td>
                                    <span class="badge @levelClass fw-bold text-uppercase px-2 py-1" style="font-size: 0.65rem; min-width: 80px; display: inline-block; text-align: center;">
                                        @log.LogLevel
                                    </span>
                                </td>
                                <td>
                                    <div class="fw-semibold text-dark small">@log.Message</div>
                                </td>
                                <td class="text-end pe-4">
                                    @if (!string.IsNullOrEmpty(log.Exception))
                                    {
                                        <button class="btn btn-link btn-sm text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#log-@log.Id">
                                            <i class="bi bi-bug-fill"></i> Xem lỗi
                                        </button>
                                    }
                                </td>
                            </tr>
                            @if (!string.IsNullOrEmpty(log.Exception))
                            {
                                <tr class="collapse bg-light-subtle" id="log-@log.Id">
                                    <td colspan="4" class="px-4 py-3">
                                        <div class="p-3 rounded bg-dark text-white border-start border-danger border-4" style="font-family: 'Courier New', Courier, monospace; font-size: 0.8rem; overflow-x: auto;">
                                            <pre class="mb-0">@log.Exception</pre>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        @if (!Model.Any())
                        {
                            <tr>
                                <td colspan="4" class="text-center py-5 text-muted small italic">Chưa có nhật ký nào được ghi lại.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-soft-info { background-color: #e3f2fd; }
    .bg-soft-warning { background-color: #fff3e0; }
    .bg-soft-danger { background-color: #ffebee; }
    .bg-soft-secondary { background-color: #f5f5f5; }
    
    .table-hover tbody tr:hover {
        background-color: rgba(78, 115, 223, 0.02);
    }
</style>
