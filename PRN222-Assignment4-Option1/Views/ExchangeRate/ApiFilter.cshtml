@using PRN222_Assignment4_Option1.BusinessLogic.Dtos
@{
    ViewData["Title"] = "Lọc tỷ giá theo API Frankfurter";
    var date = (DateTime?)(ViewBag.ApiDate) ?? DateTime.Today;
    string baseInput = ViewBag.ApiBaseInput as string ?? "";
    string symbolsInput = ViewBag.ApiSymbolsInput as string ?? "";
    var response = ViewBag.ApiResponse as FrankfurterHistoricalResponse;
}

<h1 class="mb-3">@ViewData["Title"]</h1>
<p class="text-muted mb-4">
    Dữ liệu lấy trực tiếp từ API
    <code>https://api.frankfurter.dev/v1/{yyyy-MM-dd}</code>
    với tham số <code>?base=BASE</code> và <code>&symbols=SYMBOLS</code> (tùy chọn), không dùng database.
</p>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" asp-action="ApiFilter" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Ngày</label>
                <input type="date" name="date" class="form-control" value="@date.ToString("yyyy-MM-dd")" required />
            </div>
            <div class="col-md-3">
                <label class="form-label">Base (tùy chọn)</label>
                <input type="text" name="baseCurrency" class="form-control" value="@baseInput" placeholder="VD: USD (mặc định: EUR)" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Symbols (tùy chọn)</label>
                <input type="text" name="symbols" class="form-control" value="@symbolsInput" placeholder="VD: USD,GBP (mặc định: tất cả)" />
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary">Lọc từ API</button>
                <a asp-action="Index" class="btn btn-outline-secondary ms-2">Về danh sách DB</a>
            </div>
        </form>
    </div>
</div>

@if (response is null)
{
    if (Context.Request.QueryString.HasValue)
    {
        <p class="text-muted">
            Không có dữ liệu từ API cho ngày <strong>@date.ToString("dd/MM/yyyy")</strong>
            với base <strong>@(string.IsNullOrWhiteSpace(baseInput) ? "mặc định (EUR)" : baseInput.ToUpperInvariant())</strong>
            và symbols <strong>@(string.IsNullOrWhiteSpace(symbolsInput) ? "tất cả" : symbolsInput.ToUpperInvariant())</strong>.
        </p>
    }
}
else
{
    <p class="text-muted">
        Base: <strong>@response.Base</strong> &nbsp;|&nbsp;
        Ngày dữ liệu: <strong>@response.Date.ToString("dd/MM/yyyy")</strong>
    </p>

    <div class="table-responsive" style="max-width: 32rem;">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Currency</th>
                    <th>Rate</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var kv in response.Rates.OrderBy(r => r.Key))
                {
                    <tr>
                        <td>@kv.Key</td>
                        <td>@kv.Value.ToString("N4")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

